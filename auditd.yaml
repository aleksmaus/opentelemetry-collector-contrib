# REMOVE before contributing!!!
# This is just a sample configuration for auditd POC
receivers:
  journald:
    #start_at: beginning
    priority: debug # default is info and is missing events that our auditd captures
    matches:
      - _TRANSPORT: audit

processors:
  resource:
    attributes:
      - key: data_stream.namespace
        value: default
        action: upsert
      - key: data_stream.type
        value: logs
        action: upsert
      - key: data_stream.dataset
        value: otel.auditd.log
        action: upsert
  resourcedetection/system:
    detectors: ["system"]
    system:
      hostname_sources: ["os"]
      resource_attributes:
        host.arch:
          enabled: true
        host.name:
          enabled: true
        host.id:
          enabled: true
        host.ip:
          enabled: true
        host.mac:
          enabled: true
        host.cpu.vendor.id:
          enabled: true
        host.cpu.family:
          enabled: true
        host.cpu.model.id:
          enabled: true
        host.cpu.model.name:
          enabled: true
        host.cpu.stepping:
          enabled: true
        host.cpu.cache.l2.size:
          enabled: true
        os.description:
          enabled: true
        os.type:
          enabled: true
  transform:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          # auditd
          - set(attributes["auditd.log.grantors"], body["AUDIT_FIELD_GRANTORS"])
          - set(attributes["auditd.log.op"], body["AUDIT_FIELD_OP"])
          - set(attributes["auditd.log.record_type"], body["_AUDIT_TYPE_NAME"])
          - set(attributes["auditd.log.sequence"], Int(body["_AUDIT_ID"]))
          - set(attributes["auditd.log.ses"], body["_AUDIT_SESSION"])
          - set(attributes["auditd.log.syscall"], body["_AUDIT_FIELD_SYSCALL"])
          - set(attributes["auditd.log.subj"], body["_SELINUX_CONTEXT"])
          - set(attributes["auditd.log.uid"], body["_AUDIT_LOGINUID"])
          # process
          - set(attributes["process.executable"], body["_EXE"])
          - set(attributes["process.exit_code"], Int(body["_AUDIT_FIELD_EXIT"]))
          - set(attributes["process.name"], body["_COMM"])
          - set(attributes["process.pid"], Int(body["_PID"]))
          - set(attributes["process.parent.pid"], Int(body["_PPID"]))
          # event
          - set(attributes["event.kind"], "event")
          - set(attributes["event.action"], body["_AUDIT_TYPE_NAME"])
          - set(attributes["event.dataset"], resource.attributes["data_stream.dataset"])

          # TODO: event category, type, action, outcome need to be resolved into proper values
          - set(attributes["event.category"], ["process"])
          - set(attributes["event.type"], ["info"])
          - set(attributes["event.action"], body["_AUDIT_TYPE_NAME"])
          - set(attributes["event.outcome"], ["success"])


exporters:
  debug:
    verbosity: normal
  elasticsearch:
    flush:
      interval: 1s
    endpoints:
      - https://0d1c5d78186540019eb8ddce80f4ef7c.us-west2.gcp.elastic-cloud.com
    user: elastic
    password: oQO1decGF4VPATiVNrYvR39C
    logs_index: "logs-otel.auditd.log-default"
    mapping:
      mode: otel

service:
  pipelines:
    logs:
      receivers:
        - journald
      processors: ["resource", "resourcedetection/system", "transform"]
      exporters:
        - debug
        - elasticsearch
